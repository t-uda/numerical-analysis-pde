# プログラム全体の簡単な解説

P1 有限要素法によるポアソン方程式の境界値問題の数値計算プログラム `fem.c` は，主に三つの部分からなる：

 * メッシュファイルからのデータ読み込み
   * メッシュファイルの生成は `rectmesh.c` または `genmesh.c` が担当
 * 剛性行列（と右辺ベクトル）の計算
 * 連立方程式の計算（CG 法）
   * CG 法の実装は `vector.c` が担当

ここでは，メッシュと剛性行列について簡単に解説する．

## メッシュの形式について

メッシュはグラフのように構成されている；つまり，辺は 2 つの頂点から，三角形は 3 つの辺から，メッシュは頂点集合・辺集合・三角形集合から成る．メッシュファイルの各行は，以下のいずれかの形式で書かれる．

```
NbVertices nbv
NbEdges nbe
NbTriangles nbt
Vertex id x y is_internal
Edge id p_id q_id
Triangle id e0_id e1_id e2_id
```

それぞれの意味を次に示す．

  * `nbv` は頂点数 (number of vertices)
  * `nbe` は辺数 (number of edges)
  * `nbt` は三角形数 (number of triangles)
  * `id` は頂点・辺・三角形それぞれの通し番号（添え字）
  * `x`, `y` は頂点の座標
  * `is_internal` は内部節点かどうか表す真偽値，
  * `p_id`, `q_id` は辺を構成する 2 つの頂点の添え字
  * `e0_id`, `e1_id`, `e2_id` は三角形を構成する 3 つの辺の添え字

例えば，`./rectmesh 1` や `./rectmesh 1 2` を実行した結果を見てみると分かり易い．

また，`mesh.c` でこのような形式のファイルの読み書きなどを実装している．プログラムでは，頂点・辺・三角形をそれぞれ構造体 `Vertex`, `Edge`, `Triangle` で表現し，ポインタを用いてそれらの間の参照関係を定義している．

## 剛性行列について

未知関数 `u_h` は有限要素基底関数 `φ_i` の線形和で表されるが，Dirichlet 境界条件から境界節点に対応する係数は定まり，内部節点に自由度が残る．簡単のため Dirichlet ゼロ境界を考え，内部節点に添え字 `i = 0, 1, ..., n-1` が振ってあるとする．未知関数 `u_h = Σ u_j φ_j` に関する弱問題は `〈∇u_h, ∇φ_i〉=〈f, φ_i〉` (for all `i`) であるから，解くべき連立一次方程式の係数行列の要素は `〈∇φ_j, ∇φ_i〉` という形になる．これが剛性行列である；つまり，自由度のある内部節点に対応する基底関数 `φ_i` 同士の H1 半内積によって定まる行列である．

基底関数 `φ_i` の台（関数値が非零である点の集合の閉包）は `i` 番節点を頂点にもつ三角形の和集合であるから，剛性行列の要素が非零となるのは `i == j` のときか `i` 番と `j` 番の節点が隣合うときである（ここで辺の情報を用いる）．基底関数 `φ_i` は区分線形なので，その勾配は各三角形要素上で節点の座標を用いて計算できる．具体的には，`i` 番節点の対辺の内向き法線ベクトルになる（プログラム中の`inward_normal_vector()`関数）．最後に，台が重なる三角形要素上での H1 半内積を足しあげることで剛性行列の非零要素を計算できる．

なお，プログラムは読みやすさのために剛性行列 `a[i][j]` を密行列形式にしている；つまりほとんどの要素が零であるにもかかわらず，`n*n` 個の浮動小数点数型の領域を確保しており，メモリー効率に無駄の多い格納形式である．一般に，大規模計算では代わりに疎行列格納形式を用いることが多い．
